<div class="container section">
    <div *ngIf="thread" class="flex flex-col h-[70vh] bg-surface rounded-md border"
        style="border-color: var(--border);">

        <!-- Header -->
        <div class="p-4 border-b flex justify-between items-center" style="border-color: var(--border);">
            <div>
                <h2 class="text-xl font-bold mb-0">{{ thread.listingTitle }}</h2>
                <p class="text-sm text-secondary">Chatting with {{ getOtherPartyName() }}</p>
            </div>
            <a [routerLink]="['/listings', thread.listingId]" class="btn btn-outline py-2 px-4 text-sm">View Listing</a>
        </div>

        <!-- Messages Area -->
        <div class="flex-grow overflow-y-auto p-4 flex flex-col gap-4 bg-[rgba(0,0,0,0.02)]">
            <div *ngIf="isLoading" class="text-center py-4">
                <p class="text-secondary">Loading messages...</p>
            </div>

            <div *ngFor="let msg of messages" class="max-w-[80%] p-3 rounded-lg" [ngClass]="{
             'self-end bg-primary text-white': msg.senderId === currentUserId,
             'self-start bg-white border': msg.senderId !== currentUserId
           }" [style.border-color]="msg.senderId !== currentUserId ? 'var(--border)' : 'transparent'">
                <p class="mb-1">{{ msg.body }}</p>
                <span class="text-[10px] opacity-70 block text-right">
                    {{ msg.sentAt | date:'shortTime' }}
                </span>
            </div>
        </div>

        <!-- Input Area -->
        <form (ngSubmit)="sendMessage()" class="p-4 border-t flex gap-2" style="border-color: var(--border);">
            <input type="text" name="newMessage" [(ngModel)]="newMessage" class="input flex-grow"
                placeholder="Type a message..." autocomplete="off">
            <button type="submit" class="btn btn-primary" [disabled]="!newMessage.trim()">Send</button>
        </form>
    </div>

    <div *ngIf="!thread && !isLoading" class="text-center py-20">
        <p class="text-xl text-secondary">Conversation not found.</p>
        <a routerLink="/messages" class="btn btn-primary mt-4">Back to Inbox</a>
    </div>
</div>